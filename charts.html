
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 5.8x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>5.8x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">1 .NET Threads, oha 2</div>
      <div>1 .NET worker threads, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">129,257 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">82,224 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%) <sup>*</sup></th>
        <th>Min-Max CPU (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>1 .NET Threads, oha 2</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>109,229</td>
          <td>132.8% </td>
          <td>123.3-143.8</td>
          <td>82,224 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>1 .NET Thread, oha 1</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>105,722</td>
          <td>131.1% </td>
          <td>123.5-149.2</td>
          <td>80,624 </td>
        </tr>
      
        <tr>
          <td>2 .NET Threads - oha 2</td>
          <td>2 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>129,257</td>
          <td>240.8% </td>
          <td>213.3-261.3</td>
          <td>53,670 </td>
        </tr>
      
        <tr>
          <td>No Spin</td>
          <td>Default .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>112,007</td>
          <td>391.7% </td>
          <td>340.7-463.6</td>
          <td>28,595 </td>
        </tr>
      
        <tr>
          <td>Spin 10</td>
          <td>Default .NET worker threads, semaphore spin 10, oha with 1 thread</td>
          <td>119,457</td>
          <td>616.9% </td>
          <td>576.0-745.1</td>
          <td>19,364 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default .NET worker threads, default semaphore spin, oha with 1 thread</td>
          <td>119,175</td>
          <td>840.1% </td>
          <td>604.7-904.9</td>
          <td>14,186 </td>
        </tr>
      
      
      <tr>
        <td colspan="6" style="text-align: left; font-size: 0.9em; padding-top: 10px;">
          * CPU Usage shows the average usage across all samples. <sup>(est)</sup> indicates estimated values where measurement wasn't possible.
        </td>
      </tr>
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.000924083,"slowest":0.007722584,"fastest":0.000029125,"average":0.00018247306278203044,"requestsPerSec":109229.0021112014,"totalData":13107828,"sizePerRequest":4,"sizePerSec":436914.14183563564},"responseTimeHistogram":{"0.000029125":1,"0.0007984709":3273760,"0.0015678168000000001":2642,"0.0023371627":362,"0.0031065086000000002":111,"0.0038758545000000004":2,"0.0046452004":19,"0.0054145463":7,"0.0061838922":12,"0.0069532381":20,"0.007722584":21},"latencyPercentiles":{"p10":0.00013825,"p25":0.000158208,"p50":0.000178958,"p75":0.000198334,"p90":0.000222042,"p95":0.000245042,"p99":0.000312459,"p99.9":0.000792834,"p99.99":0.001965291},"rps":{"mean":109168.86686582134,"stddev":13405.438813036139,"max":131237.17949297547,"min":2617.7582173060464,"percentiles":{"p10":98146.54033444427,"p25":109162.82727315847,"p50":111569.2621979731,"p75":115161.79022479417,"p90":118913.37775500845,"p95":121330.30051287472,"p99":125608.89310963434,"p99.9":128547.6654743541,"p99.99":131237.17949297547}},"details":{"DNSDialup":{"average":0.0004916291,"fastest":0.000437542,"slowest":0.000526708},"DNSLookup":{"average":0.0000036937500000000004,"fastest":9.59e-7,"slowest":0.000030542}},"statusCodeDistribution":{"200":3276957},"errorDistribution":{"aborted due to deadline":14},"cpuUsage":132.84333333333333,"rpsPerCore":82224,"config":{"name":"1 .NET Threads, oha 2","description":"1 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":123.3,"max":143.8,"average":132.84333333333333,"measured":true}},{"summary":{"successRate":1,"total":30.000354,"slowest":0.02690225,"fastest":0.000035708,"average":0.00018888228361562661,"requestsPerSec":105721.71915038068,"totalData":12686748,"sizePerRequest":4,"sizePerSec":422886.6099380027},"responseTimeHistogram":{"0.000035708":1,"0.0027223622000000004":3171467,"0.0054090164":173,"0.008095670600000002":6,"0.010782324800000001":0,"0.013468979":0,"0.016155633200000002":20,"0.0188422874":0,"0.0215289416":0,"0.0242155958":0,"0.02690225":20},"latencyPercentiles":{"p10":0.000131041,"p25":0.000160334,"p50":0.000189708,"p75":0.000212291,"p90":0.000236208,"p95":0.000255209,"p99":0.000304875,"p99.9":0.000717084,"p99.99":0.002409709},"rps":{"mean":105786.06602528412,"stddev":12383.52758751859,"max":134631.4229741182,"min":37.41219824724001,"percentiles":{"p10":98783.57940396412,"p25":102620.52410482602,"p50":106757.83071688865,"p75":112128.96291110864,"p90":117164.44044222872,"p95":119867.92915543282,"p99":124700.51127211902,"p99.9":131003.8122109394,"p99.99":134631.4229741182}},"details":{"DNSDialup":{"average":0.0004886897000000001,"fastest":0.000326375,"slowest":0.000565125},"DNSLookup":{"average":0.0000029667499999999996,"fastest":7.92e-7,"slowest":0.000038792}},"statusCodeDistribution":{"200":3171687},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":131.13,"rpsPerCore":80624,"config":{"name":"1 .NET Thread, oha 1","description":"1 .NET worker threads, no semaphore spin, oha with 1 thread","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":123.5,"max":149.2,"average":131.13,"measured":true}},{"summary":{"successRate":1,"total":30.000470041,"slowest":0.0365575,"fastest":0.000032875,"average":0.0001539494326260116,"requestsPerSec":129257.27479270997,"totalData":15511096,"sizePerRequest":4,"sizePerSec":517028.43251461844},"responseTimeHistogram":{"0.000032875":1,"0.0036853374999999996":3877605,"0.007337799999999999":80,"0.010990262499999999":52,"0.014642724999999999":15,"0.0182951875":1,"0.02194765":1,"0.0256001125":0,"0.029252575":0,"0.0329050375":0,"0.0365575":19},"latencyPercentiles":{"p10":0.000114125,"p25":0.000130875,"p50":0.000149875,"p75":0.00017075,"p90":0.000191542,"p95":0.0002065,"p99":0.000264208,"p99.9":0.000580708,"p99.99":0.001957542},"rps":{"mean":129233.16847400095,"stddev":14311.587120801967,"max":155237.52090880918,"min":51.80217433411113,"percentiles":{"p10":123416.96983335298,"p25":130445.68105478254,"p50":132346.4953475766,"p75":134105.02893857536,"p90":136035.7908362678,"p95":137504.26948755427,"p99":140966.95930567943,"p99.9":149106.2028180239,"p99.99":155237.52090880918}},"details":{"DNSDialup":{"average":0.00041598960000000006,"fastest":0.000371917,"slowest":0.000462417},"DNSLookup":{"average":0.000004245749999999999,"fastest":0.000001083,"slowest":0.000037625}},"statusCodeDistribution":{"200":3877774},"errorDistribution":{"aborted due to deadline":5},"cpuUsage":240.83666666666664,"rpsPerCore":53670,"config":{"name":"2 .NET Threads - oha 2","description":"2 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"2","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":213.3,"max":261.3,"average":240.83666666666664,"measured":true}},{"summary":{"successRate":1,"total":30.000856541,"slowest":0.046299333,"fastest":0.000034708,"average":0.00017826189462314678,"requestsPerSec":112007.23537368685,"totalData":13441244,"sizePerRequest":4,"sizePerSec":448028.67483569426},"responseTimeHistogram":{"0.000034708":1,"0.004661170499999999":3360250,"0.009287632999999998":20,"0.013914095499999998":0,"0.018540558":0,"0.023167020499999996":0,"0.027793482999999997":20,"0.0324199455":0,"0.037046407999999996":0,"0.041672870499999994":0,"0.04629933299999999":20},"latencyPercentiles":{"p10":0.000135584,"p25":0.000157375,"p50":0.000176292,"p75":0.000195417,"p90":0.000216375,"p95":0.000232042,"p99":0.00028175,"p99.9":0.000622084,"p99.99":0.001388041},"rps":{"mean":112185.31615201822,"stddev":9462.8977617118,"max":126658.57959306284,"min":21.67820008332679,"percentiles":{"p10":108780.47423776094,"p25":111334.9400335652,"p50":113411.99434439665,"p75":115539.46828237004,"p90":117713.29905032422,"p95":119160.86717067899,"p99":121889.39368134167,"p99.9":125806.80614821416,"p99.99":126658.57959306284}},"details":{"DNSDialup":{"average":0.00045272094999999993,"fastest":0.000374875,"slowest":0.000631375},"DNSLookup":{"average":0.000003118700000000001,"fastest":0.000001042,"slowest":0.000028958}},"statusCodeDistribution":{"200":3360311},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":391.6966666666666,"rpsPerCore":28595,"config":{"name":"No Spin","description":"Default .NET worker threads, no semaphore spin, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":340.7,"max":463.6,"average":391.6966666666666,"measured":true}},{"summary":{"successRate":1,"total":30.001018125,"slowest":0.008617625,"fastest":0.000033833,"average":0.00016712971602288597,"requestsPerSec":119457.27925191872,"totalData":14335352,"sizePerRequest":4,"sizePerSec":477828.8503500579},"responseTimeHistogram":{"0.000033833":1,"0.0008922122":3583053,"0.0017505914":576,"0.0026089706":74,"0.0034673498":22,"0.0043257289999999995":52,"0.0051841082":40,"0.006042487399999999":0,"0.0069008666":0,"0.0077592458":0,"0.008617625":20},"latencyPercentiles":{"p10":0.000126584,"p25":0.000146,"p50":0.000165167,"p75":0.00018475,"p90":0.000206625,"p95":0.000222709,"p99":0.000270166,"p99.9":0.000531417,"p99.99":0.001303167},"rps":{"mean":119449.05224532432,"stddev":9957.128733322084,"max":136222.1360971354,"min":16606.85032575866,"percentiles":{"p10":112230.40321623729,"p25":117036.09393136362,"p50":120721.12619708198,"p75":124321.17131398212,"p90":127574.69267397663,"p95":129450.16193776496,"p99":132569.05522085863,"p99.9":134788.1784263286,"p99.99":136222.1360971354}},"details":{"DNSDialup":{"average":0.00040572714999999993,"fastest":0.000330542,"slowest":0.00052},"DNSLookup":{"average":0.00000252295,"fastest":7.91e-7,"slowest":0.000029375}},"statusCodeDistribution":{"200":3583838},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":616.9033333333333,"rpsPerCore":19364,"config":{"name":"Spin 10","description":"Default .NET worker threads, semaphore spin 10, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"10"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":576,"max":745.1,"average":616.9033333333333,"measured":true}},{"summary":{"successRate":1,"total":30.001224875,"slowest":0.054333375,"fastest":0.000030708,"average":0.0001675318771313314,"requestsPerSec":119175.26750647377,"totalData":14301612,"sizePerRequest":4,"sizePerSec":476700.9366980054},"responseTimeHistogram":{"0.000030708":1,"0.0054609747":3575308,"0.010891241400000001":24,"0.016321508100000003":50,"0.021751774800000002":0,"0.0271820415":0,"0.0326123082":0,"0.0380425749":0,"0.0434728416":0,"0.0489031083":0,"0.054333374999999996":20},"latencyPercentiles":{"p10":0.000125667,"p25":0.000145125,"p50":0.000163708,"p75":0.000181042,"p90":0.000199042,"p95":0.000213833,"p99":0.000415458,"p99.9":0.000578917,"p99.99":0.0023795},"rps":{"mean":119325.97812109134,"stddev":15184.657686832747,"max":141646.63007063075,"min":18.469494324084618,"percentiles":{"p10":107403.58727981376,"p25":116470.79459744059,"p50":122026.44313022753,"p75":128327.79580057062,"p90":130906.54532727589,"p95":132310.81030361087,"p99":136443.77116175342,"p99.9":139440.67484487678,"p99.99":141646.63007063075}},"details":{"DNSDialup":{"average":0.0016730666999999998,"fastest":0.001098333,"slowest":0.001951167},"DNSLookup":{"average":0.000006018800000000001,"fastest":7.08e-7,"slowest":0.000103709}},"statusCodeDistribution":{"200":3575403},"errorDistribution":{"aborted due to deadline":1},"cpuUsage":840.1166666666664,"rpsPerCore":14186,"config":{"name":"Base Case","description":"Default .NET worker threads, default semaphore spin, oha with 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":604.7,"max":904.9,"average":840.1166666666664,"measured":true}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second',
          data: [109229.0021112014,105721.71915038068,129257.27479270997,112007.23537368685,119457.27925191872,119175.26750647377],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [132.84333333333333,131.13,240.83666666666664,391.6966666666666,616.9033333333333,840.1166666666664],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [82224,80624,53670,28595,19364,14186],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  