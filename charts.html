
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
    details {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      border: 1px solid #eee;
    }
    details summary {
      cursor: pointer;
      padding: 5px 0;
      font-weight: 600;
      color: #0066cc;
    }
    .system-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .system-info div {
      padding: 8px;
      border-radius: 4px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .system-info strong {
      font-weight: 600;
      color: #555;
      margin-right: 5px;
    }
    @media print {
      details {
        display: block;
      }
      details summary {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  
  
  <details>
    <summary>System Information & Benchmark Environment</summary>
    <div class="system-info">
      <div><strong>Date:</strong> 3/17/2025 12:44:14 PM</div>
      <div><strong>OS:</strong> macOS 15.3.2</div>
      <div><strong>CPU:</strong> Apple M2 Max</div>
      <div><strong>CPU Cores:</strong> 12</div>
      <div><strong>Memory:</strong> 32.00 GB Total</div>
      <div><strong>Free Memory:</strong> 2.78 GB</div>
      <div><strong>.NET Version:</strong> 10.0.100-preview.1.25120.13</div>
      <div><strong>.NET Runtime:</strong> OS Name:     Mac OS X</div>
      <div><strong>Node.js:</strong> v20.13.1</div>
      <div><strong>Load Tester:</strong> oha 1.5.0</div>
    </div>
  </details>
  
  
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 7.1x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>7.1x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">1 .NET Threads, oha 2</div>
      <div>1 .NET worker threads, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">132,358 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">84,799 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%) <sup>*</sup></th>
        <th>Min-Max CPU (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>1 .NET Threads, oha 2</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>112,042</td>
          <td>132.1% </td>
          <td>121.3-139.8</td>
          <td>84,799 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>1 .NET Thread, oha 1</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>109,575</td>
          <td>130.5% </td>
          <td>123.7-153.1</td>
          <td>83,957 </td>
        </tr>
      
        <tr>
          <td>2 .NET Threads - oha 2</td>
          <td>2 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>132,358</td>
          <td>242.3% </td>
          <td>223.6-268.0</td>
          <td>54,630 </td>
        </tr>
      
        <tr>
          <td>No Spin</td>
          <td>Default .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>113,575</td>
          <td>398.6% </td>
          <td>381.4-484.8</td>
          <td>28,491 </td>
        </tr>
      
        <tr>
          <td>Spin 10</td>
          <td>Default .NET worker threads, semaphore spin 10, oha with 1 thread</td>
          <td>123,595</td>
          <td>639.7% </td>
          <td>590.5-810.3</td>
          <td>19,320 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default .NET worker threads, default semaphore spin, oha with 1 thread</td>
          <td>111,824</td>
          <td>936.5% </td>
          <td>817.8-987.0</td>
          <td>11,941 </td>
        </tr>
      
      
      <tr>
        <td colspan="6" style="text-align: left; font-size: 0.9em; padding-top: 10px;">
          * CPU Usage shows the average usage across all samples. <sup>(est)</sup> indicates estimated values where measurement wasn't possible.
        </td>
      </tr>
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.000536166,"slowest":0.003070875,"fastest":0.000033875,"average":0.00017797160550154294,"requestsPerSec":112042.26422491198,"totalData":13445284,"sizePerRequest":4,"sizePerSec":448168.12358299503},"responseTimeHistogram":{"0.000033875":1,"0.00033757499999999995":3358666,"0.000641275":2574,"0.0009449749999999998":0,"0.0012486749999999999":0,"0.001552375":0,"0.0018560749999999998":27,"0.0021597749999999996":14,"0.0024634749999999997":19,"0.0027671749999999998":0,"0.003070875":20},"latencyPercentiles":{"p10":0.000138583,"p25":0.000157667,"p50":0.000177833,"p75":0.000195125,"p90":0.000214291,"p95":0.000231333,"p99":0.000277959,"p99.9":0.000329416,"p99.99":0.000476792},"rps":{"mean":112034.6820347753,"stddev":10253.692398526584,"max":132545.20863597243,"min":32253.489186466835,"percentiles":{"p10":107966.58299172852,"p25":109700.04571840436,"p50":112329.94716391986,"p75":117028.77737634971,"p90":121988.34971000672,"p95":124553.96923489039,"p99":128503.21258033197,"p99.9":131389.2395715516,"p99.99":132545.20863597243}},"details":{"DNSDialup":{"average":0.00055530215,"fastest":0.000450583,"slowest":0.000598625},"DNSLookup":{"average":0.0000035622999999999998,"fastest":9.16e-7,"slowest":0.000031541}},"statusCodeDistribution":{"200":3361321},"errorDistribution":{"aborted due to deadline":7},"cpuUsage":132.12666666666664,"rpsPerCore":84799,"config":{"name":"1 .NET Threads, oha 2","description":"1 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":121.3,"max":139.8,"average":132.12666666666664,"measured":true}},{"summary":{"successRate":1,"total":30.000843125,"slowest":0.002096916,"fastest":0.00003675,"average":0.00018224531658275934,"requestsPerSec":109575.32047693076,"totalData":13149396,"sizePerRequest":4,"sizePerSec":438300.8819189644},"responseTimeHistogram":{"0.00003675":1,"0.0002427666":3120513,"0.0004487832":166005,"0.0006547997999999999":333,"0.0008608164":261,"0.001066833":107,"0.0012728495999999997":40,"0.0014788661999999998":21,"0.0016848827999999998":12,"0.0018908993999999998":14,"0.002096916":42},"latencyPercentiles":{"p10":0.000127084,"p25":0.000155666,"p50":0.00018475,"p75":0.000208917,"p90":0.000228333,"p95":0.000243083,"p99":0.000278541,"p99.9":0.000336042,"p99.99":0.000786583},"rps":{"mean":109574.02549495974,"stddev":9269.867398774688,"max":132204.95768592702,"min":22918.19959470123,"percentiles":{"p10":100433.89644005428,"p25":104037.6676726999,"p50":109724.22710934507,"p75":115675.22854141076,"p90":120645.88305460554,"p95":123314.39078939367,"p99":127213.79827620965,"p99.9":129672.39609876886,"p99.99":132204.95768592702}},"details":{"DNSDialup":{"average":0.0007080812499999999,"fastest":0.000452166,"slowest":0.0008255},"DNSLookup":{"average":0.0000020645999999999997,"fastest":7.91e-7,"slowest":0.000021459}},"statusCodeDistribution":{"200":3287349},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":130.51333333333332,"rpsPerCore":83957,"config":{"name":"1 .NET Thread, oha 1","description":"1 .NET worker threads, no semaphore spin, oha with 1 thread","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":123.7,"max":153.1,"average":130.51333333333332,"measured":true}},{"summary":{"successRate":1,"total":30.000809834,"slowest":0.003769875,"fastest":0.000030167,"average":0.0001503627451859457,"requestsPerSec":132358.29372511865,"totalData":15883408,"sizePerRequest":4,"sizePerSec":529432.6415815379},"responseTimeHistogram":{"0.000030167":1,"0.00040413779999999994":3967942,"0.0007781085999999999":2292,"0.0011520793999999998":239,"0.0015260501999999998":126,"0.0019000209999999998":136,"0.0022739918":56,"0.0026479626":27,"0.0030219334":24,"0.0033959041999999996":3,"0.003769875":6},"latencyPercentiles":{"p10":0.000114291,"p25":0.0001305,"p50":0.000148583,"p75":0.000168125,"p90":0.000186916,"p95":0.00019925,"p99":0.000229292,"p99.9":0.00035525,"p99.99":0.001085333},"rps":{"mean":132350.6891063057,"stddev":8028.799661538634,"max":153912.82093798195,"min":23508.6206111778,"percentiles":{"p10":130061.74927037234,"p25":132059.98164366678,"p50":133523.92748781978,"p75":135013.21286575618,"p90":136754.98442384746,"p95":137905.75066981625,"p99":141041.44723961595,"p99.9":149299.53800199018,"p99.99":153912.82093798195}},"details":{"DNSDialup":{"average":0.0007242583,"fastest":0.000618041,"slowest":0.000809458},"DNSLookup":{"average":0.000004300000000000001,"fastest":9.16e-7,"slowest":0.000039625}},"statusCodeDistribution":{"200":3970852},"errorDistribution":{"aborted due to deadline":4},"cpuUsage":242.28333333333333,"rpsPerCore":54630,"config":{"name":"2 .NET Threads - oha 2","description":"2 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"2","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":223.6,"max":268,"average":242.28333333333333,"measured":true}},{"summary":{"successRate":1,"total":30.00088475,"slowest":0.007464709,"fastest":0.000030083,"average":0.000175809686900127,"requestsPerSec":113575.4171383229,"totalData":13629440,"sizePerRequest":4,"sizePerSec":454301.26856508787},"responseTimeHistogram":{"0.000030083":1,"0.0007735455999999999":3406691,"0.0015170081999999999":464,"0.0022604708":115,"0.0030039334":9,"0.003747396":39,"0.0044908586":21,"0.0052343212":0,"0.0059777838":0,"0.0067212463999999994":0,"0.007464709":20},"latencyPercentiles":{"p10":0.000135209,"p25":0.000157,"p50":0.000175958,"p75":0.000194458,"p90":0.000213542,"p95":0.000227,"p99":0.000259167,"p99.9":0.000381042,"p99.99":0.001022208},"rps":{"mean":113574.83490336595,"stddev":5647.891140791375,"max":127471.16715260247,"min":24603.178730693315,"percentiles":{"p10":110338.15493397988,"p25":111947.5777205328,"p50":113809.54168389986,"p75":115823.1646329323,"p90":117710.29965121689,"p95":119136.72985380805,"p99":122331.82507552969,"p99.9":125906.68841970433,"p99.99":127471.16715260247}},"details":{"DNSDialup":{"average":0.0007093104,"fastest":0.000474083,"slowest":0.000787625},"DNSLookup":{"average":0.0000021208000000000005,"fastest":8.33e-7,"slowest":0.000023583}},"statusCodeDistribution":{"200":3407360},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":398.63,"rpsPerCore":28491,"config":{"name":"No Spin","description":"Default .NET worker threads, no semaphore spin, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":381.4,"max":484.8,"average":398.63,"measured":true}},{"summary":{"successRate":1,"total":30.000977417,"slowest":0.007865583,"fastest":0.000031542,"average":0.00016154251984494382,"requestsPerSec":123595.07320247786,"totalData":14831884,"sizePerRequest":4,"sizePerSec":494380.0261519326},"responseTimeHistogram":{"0.000031542":1,"0.0008149460999999999":3707729,"0.0015983502":80,"0.0023817542999999995":47,"0.0031651583999999996":33,"0.0039485625":1,"0.004731966599999999":40,"0.005515370699999999":0,"0.0062987747999999994":20,"0.0070821789":0,"0.007865583":20},"latencyPercentiles":{"p10":0.000123667,"p25":0.000141959,"p50":0.000160583,"p75":0.000179625,"p90":0.000200167,"p95":0.0002145,"p99":0.000248375,"p99.9":0.00033175,"p99.99":0.000614667},"rps":{"mean":123596.70197825492,"stddev":7724.54014392196,"max":138257.50460233778,"min":32505.145564544913,"percentiles":{"p10":116702.62405298326,"p25":120592.91920585417,"p50":124309.32319924113,"p75":127917.05134292605,"p90":131103.27758193406,"p95":132635.91780657158,"p99":135222.54159770274,"p99.9":137604.0180373321,"p99.99":138257.50460233778}},"details":{"DNSDialup":{"average":0.000760827,"fastest":0.000519208,"slowest":0.000885666},"DNSLookup":{"average":0.0000025083,"fastest":7.92e-7,"slowest":0.000031291}},"statusCodeDistribution":{"200":3707971},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":639.7399999999999,"rpsPerCore":19320,"config":{"name":"Spin 10","description":"Default .NET worker threads, semaphore spin 10, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"10"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":590.5,"max":810.3,"average":639.7399999999999,"measured":true}},{"summary":{"successRate":1,"total":30.001128459,"slowest":0.033754,"fastest":0.000038833,"average":0.00017855105825463464,"requestsPerSec":111823.8937106909,"totalData":13419360,"sizePerRequest":4,"sizePerSec":447295.17485780915},"responseTimeHistogram":{"0.000038833":1,"0.0034103496999999994":3354777,"0.006781866399999999":22,"0.010153383099999998":20,"0.013524899799999998":0,"0.016896416499999997":0,"0.020267933199999994":0,"0.023639449899999995":0,"0.027010966599999995":0,"0.030382483299999995":0,"0.033754":20},"latencyPercentiles":{"p10":0.000128667,"p25":0.000149333,"p50":0.000169,"p75":0.000187792,"p90":0.000212042,"p95":0.000282042,"p99":0.00044775,"p99.9":0.000560583,"p99.99":0.000912875},"rps":{"mean":111881.69822654953,"stddev":16815.83063362173,"max":138311.20020042986,"min":29.939634810104625,"percentiles":{"p10":86339.93221864417,"p25":108837.35031073936,"p50":117046.76970457102,"p75":122249.91464014324,"p90":126421.40045412762,"p95":128103.74062919727,"p99":131013.101310124,"p99.9":137516.02392197476,"p99.99":138311.20020042986}},"details":{"DNSDialup":{"average":0.0003288771,"fastest":0.000054375,"slowest":0.000415667},"DNSLookup":{"average":0.0000021583,"fastest":7.91e-7,"slowest":0.000023625}},"statusCodeDistribution":{"200":3354840},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":936.4833333333336,"rpsPerCore":11941,"config":{"name":"Base Case","description":"Default .NET worker threads, default semaphore spin, oha with 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":817.8,"max":987,"average":936.4833333333336,"measured":true}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second',
          data: [112042.26422491198,109575.32047693076,132358.29372511865,113575.4171383229,123595.07320247786,111823.8937106909],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [132.12666666666664,130.51333333333332,242.28333333333333,398.63,639.7399999999999,936.4833333333336],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [84799,83957,54630,28491,19320,11941],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  