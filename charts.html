
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
    details {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      border: 1px solid #eee;
    }
    details summary {
      cursor: pointer;
      padding: 5px 0;
      font-weight: 600;
      color: #0066cc;
    }
    .system-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .system-info div {
      padding: 8px;
      border-radius: 4px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .system-info strong {
      font-weight: 600;
      color: #555;
      margin-right: 5px;
    }
    @media print {
      details {
        display: block;
      }
      details summary {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  
  
  <details>
    <summary>System Information & Benchmark Environment</summary>
    <div class="system-info">
      <div><strong>Date:</strong> 3/17/2025 12:39:03 PM</div>
      <div><strong>OS:</strong> macOS 15.3.2</div>
      <div><strong>CPU:</strong> Apple M2 Max</div>
      <div><strong>CPU Cores:</strong> 12</div>
      <div><strong>Memory:</strong> 32.00 GB Total</div>
      <div><strong>Free Memory:</strong> 0.09 GB</div>
      <div><strong>.NET Version:</strong> 10.0.100-preview.1.25120.13</div>
      <div><strong>.NET Runtime:</strong> OS Name:     Mac OS X</div>
      <div><strong>Node.js:</strong> v20.13.1</div>
      <div><strong>Load Tester:</strong> oha 1.5.0</div>
    </div>
  </details>
  
  
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 6.2x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>6.2x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">1 .NET Threads, oha 2</div>
      <div>1 .NET worker threads, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">127,502 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">83,173 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%) <sup>*</sup></th>
        <th>Min-Max CPU (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>1 .NET Threads, oha 2</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>109,839</td>
          <td>132.1% </td>
          <td>119.2-154.4</td>
          <td>83,173 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>1 .NET Thread, oha 1</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>106,394</td>
          <td>131.0% </td>
          <td>122.0-150.1</td>
          <td>81,210 </td>
        </tr>
      
        <tr>
          <td>2 .NET Threads - oha 2</td>
          <td>2 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>127,502</td>
          <td>237.2% </td>
          <td>178.2-246.4</td>
          <td>53,743 </td>
        </tr>
      
        <tr>
          <td>No Spin</td>
          <td>Default .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>112,593</td>
          <td>392.6% </td>
          <td>339.5-485.0</td>
          <td>28,681 </td>
        </tr>
      
        <tr>
          <td>Spin 10</td>
          <td>Default .NET worker threads, semaphore spin 10, oha with 1 thread</td>
          <td>105,348</td>
          <td>534.8% </td>
          <td>53.9-765.6</td>
          <td>19,697 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default .NET worker threads, default semaphore spin, oha with 1 thread</td>
          <td>115,553</td>
          <td>862.9% </td>
          <td>759.6-919.4</td>
          <td>13,391 </td>
        </tr>
      
      
      <tr>
        <td colspan="6" style="text-align: left; font-size: 0.9em; padding-top: 10px;">
          * CPU Usage shows the average usage across all samples. <sup>(est)</sup> indicates estimated values where measurement wasn't possible.
        </td>
      </tr>
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.000853959,"slowest":0.017755875,"fastest":0.000028541,"average":0.00018150852366830898,"requestsPerSec":109838.80673874787,"totalData":13181008,"sizePerRequest":4,"sizePerSec":439354.42697776307},"responseTimeHistogram":{"0.000028541":1,"0.0018012744":3295091,"0.0035740078":100,"0.0053467411999999995":0,"0.0071194746":0,"0.008892208":0,"0.010664941399999999":40,"0.0124376748":0,"0.0142104082":0,"0.0159831416":0,"0.017755875":20},"latencyPercentiles":{"p10":0.000143084,"p25":0.000163667,"p50":0.000182333,"p75":0.000196458,"p90":0.000214375,"p95":0.000231958,"p99":0.000272125,"p99.9":0.000346708,"p99.99":0.0008565},"rps":{"mean":109864.58526633882,"stddev":9457.302587077214,"max":132848.15745707744,"min":57.23579826739567,"percentiles":{"p10":105305.26526327082,"p25":107787.7395213303,"p50":110511.05110511441,"p75":114033.25209628987,"p90":118319.62429398492,"p95":121223.73560742808,"p99":125430.30396142938,"p99.9":128927.93868431417,"p99.99":132848.15745707744}},"details":{"DNSDialup":{"average":0.00042619175000000007,"fastest":0.000343958,"slowest":0.000492375},"DNSLookup":{"average":0.000006354249999999999,"fastest":7.92e-7,"slowest":0.000059334}},"statusCodeDistribution":{"200":3295252},"errorDistribution":{"aborted due to deadline":6},"cpuUsage":132.06,"rpsPerCore":83173,"config":{"name":"1 .NET Threads, oha 2","description":"1 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":119.2,"max":154.4,"average":132.06,"measured":true}},{"summary":{"successRate":1,"total":30.000948416,"slowest":0.011173958,"fastest":0.000033458,"average":0.00018769657902079442,"requestsPerSec":106393.80314715981,"totalData":12767652,"sizePerRequest":4,"sizePerSec":425574.94593040267},"responseTimeHistogram":{"0.000033458":1,"0.001147508":3191536,"0.002261558":256,"0.0033756079999999996":20,"0.004489658":40,"0.005603708":20,"0.006717757999999999":0,"0.007831807999999999":0,"0.008945858":0,"0.010059908":0,"0.011173958":40},"latencyPercentiles":{"p10":0.000134041,"p25":0.000162,"p50":0.000190166,"p75":0.000211667,"p90":0.000232584,"p95":0.000248667,"p99":0.000290042,"p99.9":0.000397958,"p99.99":0.001273041},"rps":{"mean":106383.56013116108,"stddev":10282.49323342401,"max":131663.63303383905,"min":91.01010385072104,"percentiles":{"p10":98729.14046210138,"p25":101253.987063517,"p50":105835.7195553466,"p75":112486.53642335153,"p90":118430.94033363806,"p95":121505.56495488471,"p99":126053.57276842836,"p99.9":130456.06899409978,"p99.99":131663.63303383905}},"details":{"DNSDialup":{"average":0.0006057876,"fastest":0.000388583,"slowest":0.000699958},"DNSLookup":{"average":0.00000233745,"fastest":7.91e-7,"slowest":0.00002775}},"statusCodeDistribution":{"200":3191913},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":131.01000000000002,"rpsPerCore":81210,"config":{"name":"1 .NET Thread, oha 1","description":"1 .NET worker threads, no semaphore spin, oha with 1 thread","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":122,"max":150.1,"average":131.01000000000002,"measured":true}},{"summary":{"successRate":1,"total":30.000861291,"slowest":0.010191209,"fastest":0.000025959,"average":0.00015605846386979884,"requestsPerSec":127501.70613093417,"totalData":15300604,"sizePerRequest":4,"sizePerSec":510005.4912286818},"responseTimeHistogram":{"0.000025959":1,"0.001042484":3824042,"0.0020590089999999997":795,"0.0030755339999999996":120,"0.0040920589999999995":112,"0.005108583999999999":11,"0.006125108999999999":1,"0.007141633999999999":18,"0.008158159":11,"0.009174684":19,"0.010191209":21},"latencyPercentiles":{"p10":0.00011475,"p25":0.000131666,"p50":0.000151,"p75":0.000172708,"p90":0.000195958,"p95":0.000214625,"p99":0.000298125,"p99.9":0.000570541,"p99.99":0.00174375},"rps":{"mean":127477.36652782047,"stddev":15083.411097644332,"max":150623.84375448918,"min":99.89635752906122,"percentiles":{"p10":112745.09803921563,"p25":128684.71314665867,"p50":132104.95393573944,"p75":134380.06364193305,"p90":136706.26114677152,"p95":138543.29477962301,"p99":142001.1786097569,"p99.9":147004.7408778753,"p99.99":150623.84375448918}},"details":{"DNSDialup":{"average":0.0005978416500000001,"fastest":0.000542416,"slowest":0.000645416},"DNSLookup":{"average":0.00001155835,"fastest":9.16e-7,"slowest":0.000111125}},"statusCodeDistribution":{"200":3825151},"errorDistribution":{"aborted due to deadline":10},"cpuUsage":237.2433333333333,"rpsPerCore":53743,"config":{"name":"2 .NET Threads - oha 2","description":"2 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"2","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":178.2,"max":246.4,"average":237.2433333333333,"measured":true}},{"summary":{"successRate":1,"total":30.000865167,"slowest":0.035382666,"fastest":0.000039375,"average":0.00017734091918092805,"requestsPerSec":112592.78628122904,"totalData":13511512,"sizePerRequest":4,"sizePerSec":450370.7451364514},"responseTimeHistogram":{"0.000039375":1,"0.0035737040999999996":3377733,"0.0071080332":84,"0.010642362299999998":0,"0.014176691399999998":20,"0.0177110205":20,"0.021245349599999998":0,"0.0247796787":0,"0.0283140078":0,"0.031848336899999996":0,"0.035382666":20},"latencyPercentiles":{"p10":0.000135584,"p25":0.000157083,"p50":0.000175625,"p75":0.000194375,"p90":0.000215125,"p95":0.000230833,"p99":0.000279625,"p99.9":0.000527792,"p99.99":0.001632833},"rps":{"mean":112715.40849800702,"stddev":8755.03494137004,"max":127533.47753783985,"min":28.42904696936137,"percentiles":{"p10":108714.50251462108,"p25":111934.05033811409,"p50":113979.78585007826,"p75":116107.25670352812,"p90":118106.38955568166,"p95":119457.74587436164,"p99":122065.10952942453,"p99.9":125527.4257372949,"p99.99":127533.47753783985}},"details":{"DNSDialup":{"average":0.00081793765,"fastest":0.000463084,"slowest":0.000921083},"DNSLookup":{"average":0.0000019436999999999997,"fastest":7.91e-7,"slowest":0.00002}},"statusCodeDistribution":{"200":3377878},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":392.5666666666667,"rpsPerCore":28681,"config":{"name":"No Spin","description":"Default .NET worker threads, no semaphore spin, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":339.5,"max":485,"average":392.5666666666667,"measured":true}},{"summary":{"successRate":1,"total":30.001291666,"slowest":0.204415,"fastest":0.000032166,"average":0.00018952841666559968,"requestsPerSec":105348.19751050381,"totalData":12642320,"sizePerRequest":4,"sizePerSec":421392.5233868296},"responseTimeHistogram":{"0.000032166":1,"0.0204704494":3160396,"0.0409087328":67,"0.0613470162":57,"0.0817852996":19,"0.102223583":4,"0.1226618664":16,"0.1431001498":0,"0.1635384332":0,"0.1839767166":0,"0.204415":20},"latencyPercentiles":{"p10":0.000128708,"p25":0.000148833,"p50":0.000169583,"p75":0.0001925,"p90":0.000225375,"p95":0.00027575,"p99":0.000529041,"p99.9":0.001887292,"p99.99":0.012164834},"rps":{"mean":106840.16465097548,"stddev":27543.839667321696,"max":143171.4742143236,"min":4.898131118071893,"percentiles":{"p10":68630.59551946756,"p25":103142.97967962726,"p50":117327.86394644144,"p75":123014.87249807264,"p90":127337.66648174303,"p95":129661.58925490457,"p99":133137.17189842166,"p99.9":136627.5144592409,"p99.99":143171.4742143236}},"details":{"DNSDialup":{"average":0.00072578335,"fastest":0.000492709,"slowest":0.000819333},"DNSLookup":{"average":0.0000019895500000000003,"fastest":8.33e-7,"slowest":0.000020959}},"statusCodeDistribution":{"200":3160580},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":534.8433333333331,"rpsPerCore":19697,"config":{"name":"Spin 10","description":"Default .NET worker threads, semaphore spin 10, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"10"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":53.9,"max":765.6,"average":534.8433333333331,"measured":true}},{"summary":{"successRate":1,"total":30.002514584,"slowest":0.048982125,"fastest":0.000038542,"average":0.00017278157517730124,"requestsPerSec":115552.98107742102,"totalData":13867508,"sizePerRequest":4,"sizePerSec":462211.52434320905},"responseTimeHistogram":{"0.000038542":1,"0.0049329003":3466781,"0.009827258600000001":71,"0.014721616900000001":3,"0.0196159752":1,"0.0245103335":0,"0.0294046918":0,"0.034299050100000006":0,"0.039193408400000004":0,"0.0440877667":0,"0.048982125":20},"latencyPercentiles":{"p10":0.000126875,"p25":0.000147209,"p50":0.000166625,"p75":0.000184708,"p90":0.000205209,"p95":0.000224792,"p99":0.000442541,"p99.9":0.000585791,"p99.99":0.002926375},"rps":{"mean":115668.77385600487,"stddev":14939.714702347428,"max":138801.73502168636,"min":20.498174094395644,"percentiles":{"p10":98821.4047162617,"p25":114417.64320058135,"p50":119148.64839312411,"p75":123891.1441888817,"p90":127530.82420022506,"p95":129631.87647844118,"p99":133001.41357785978,"p99.9":137036.53393995567,"p99.99":138801.73502168636}},"details":{"DNSDialup":{"average":0.00148584175,"fastest":0.001205708,"slowest":0.001551959},"DNSLookup":{"average":0.0000051542000000000006,"fastest":7.08e-7,"slowest":0.000086708}},"statusCodeDistribution":{"200":3466877},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":862.9266666666667,"rpsPerCore":13391,"config":{"name":"Base Case","description":"Default .NET worker threads, default semaphore spin, oha with 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":759.6,"max":919.4,"average":862.9266666666667,"measured":true}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second',
          data: [109838.80673874787,106393.80314715981,127501.70613093417,112592.78628122904,105348.19751050381,115552.98107742102],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [132.06,131.01000000000002,237.2433333333333,392.5666666666667,534.8433333333331,862.9266666666667],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread, oha 1","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [83173,81210,53743,28681,19697,13391],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  