
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 3.7x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>3.7x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">Single Worker Thread</div>
      <div>1 worker thread, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">135,878.063 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">81,901 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%) <sup>*</sup></th>
        <th>Min-Max CPU (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>Single Worker Thread</td>
          <td>1 worker thread, no semaphore spin, oha with 2 threads</td>
          <td>109,670</td>
          <td>133.9% </td>
          <td>0.0-142.0</td>
          <td>81,901 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>No Semaphore Spin</td>
          <td>Disabling Semaphore spinning</td>
          <td>125,763</td>
          <td>389.6% </td>
          <td>0.0-452.9</td>
          <td>32,278 </td>
        </tr>
      
        <tr>
          <td>No Spin + Tokio 2 Threads</td>
          <td>No semaphore spin with oha limited to 2 threads</td>
          <td>127,123</td>
          <td>424.1% </td>
          <td>4.4-513.2</td>
          <td>29,976 </td>
        </tr>
      
        <tr>
          <td>No Spin + Tokio 1 Thread</td>
          <td>No semaphore spin with oha limited to 1 thread</td>
          <td>113,995</td>
          <td>399.9% </td>
          <td>10.5-507.3</td>
          <td>28,507 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default configuration</td>
          <td>135,878</td>
          <td>617.6% </td>
          <td>0.0-670.5</td>
          <td>21,999 </td>
        </tr>
      
        <tr>
          <td>Tokio 1 Thread</td>
          <td>Default config with oha limited to 1 thread</td>
          <td>114,935</td>
          <td>863.9% </td>
          <td>13.0-898.5</td>
          <td>13,305 </td>
        </tr>
      
      
      <tr>
        <td colspan="6" style="text-align: left; font-size: 0.9em; padding-top: 10px;">
          * CPU Usage shows the average usage across all samples. <sup>(est)</sup> indicates estimated values where measurement wasn't possible.
        </td>
      </tr>
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.000965791,"slowest":0.010436125,"fastest":0.000027291,"average":0.00018173931527326292,"requestsPerSec":109670.3027136224,"totalData":13160812,"sizePerRequest":4,"sizePerSec":438679.6109059968},"responseTimeHistogram":{"0.000027291":1,"0.0010681744":3289031,"0.0021090578":1017,"0.0031499412":100,"0.0041908245999999994":16,"0.005231707999999999":18,"0.006272591399999999":0,"0.0073134748":0,"0.0083543582":0,"0.0093952416":0,"0.010436125":20},"latencyPercentiles":{"p10":0.000138375,"p25":0.00015825,"p50":0.000179208,"p75":0.000199083,"p90":0.0002215,"p95":0.000242584,"p99":0.000292125,"p99.9":0.000726875,"p99.99":0.001582417},"rps":{"mean":109650.84701820649,"stddev":12457.071984426464,"max":130275.62370583389,"min":98.15228326750118,"percentiles":{"p10":106478.9754560952,"p25":109033.1678896684,"p50":111269.50376811127,"p75":114776.37468788729,"p90":118754.63492504053,"p95":121411.28558436793,"p99":125374.78391390377,"p99.9":128546.0580526005,"p99.99":130275.62370583389}},"details":{"DNSDialup":{"average":0.0007427416000000001,"fastest":0.000571375,"slowest":0.000827667},"DNSLookup":{"average":0.00000478755,"fastest":9.17e-7,"slowest":0.000048}},"statusCodeDistribution":{"200":3290203},"errorDistribution":{"aborted due to deadline":12},"cpuUsage":133.9066666666667,"rpsPerCore":81901,"config":{"name":"Single Worker Thread","description":"1 worker thread, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":0,"max":142,"average":133.9066666666667,"measured":true}},{"summary":{"successRate":1,"total":30.001129541,"slowest":0.006956541,"fastest":0.000031917,"average":0.0001570078455543187,"requestsPerSec":125763.06484873225,"totalData":15092116,"sizePerRequest":4,"sizePerSec":503051.5927533623},"responseTimeHistogram":{"0.000031917":1,"0.0007243794":3772525,"0.0014168418":194,"0.0021093042":97,"0.0028017665999999996":52,"0.0034942289999999993":65,"0.0041866914":19,"0.0048791538":5,"0.0055716162":29,"0.0062640785999999995":24,"0.006956540999999999":18},"latencyPercentiles":{"p10":0.000105125,"p25":0.000128667,"p50":0.000155625,"p75":0.000182958,"p90":0.000208042,"p95":0.000223625,"p99":0.000256292,"p99.9":0.000335833,"p99.99":0.000960875},"rps":{"mean":125737.69095457629,"stddev":8661.109263289722,"max":141165.88211718417,"min":3301.7747039030432,"percentiles":{"p10":118521.72503219837,"p25":123292.97523262417,"p50":127442.85069133359,"p75":130242.7330111202,"p90":132200.71018985083,"p95":133381.69628898683,"p99":136015.87305239675,"p99.9":139603.63791246474,"p99.99":141165.88211718417}},"details":{"DNSDialup":{"average":0.0005236414500000001,"fastest":0.000419,"slowest":0.000743916},"DNSLookup":{"average":0.00009098334999999998,"fastest":0.000001791,"slowest":0.000310875}},"statusCodeDistribution":{"200":3773029},"errorDistribution":{"aborted due to deadline":5},"cpuUsage":389.6299999999999,"rpsPerCore":32278,"config":{"name":"No Semaphore Spin","description":"Disabling Semaphore spinning","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{}},"cpuMeasurement":{"samples":32,"min":0,"max":452.9,"average":389.6299999999999,"measured":true}},{"summary":{"successRate":1,"total":30.000851875,"slowest":0.003531625,"fastest":0.000031458,"average":0.00015650838519901824,"requestsPerSec":127123.12356630374,"totalData":15255200,"sizePerRequest":4,"sizePerSec":508492.2276061203},"responseTimeHistogram":{"0.000031458":1,"0.0003814747":3810065,"0.0007314914":3080,"0.0010815081":341,"0.0014315248":97,"0.0017815415000000002":102,"0.0021315581999999996":61,"0.0024815748999999997":8,"0.0028315916":5,"0.0031816083":15,"0.003531625":25},"latencyPercentiles":{"p10":0.0001125,"p25":0.000131666,"p50":0.000153625,"p75":0.000177292,"p90":0.000202458,"p95":0.000220208,"p99":0.00026075,"p99.9":0.000379208,"p99.99":0.000983959},"rps":{"mean":127122.05950201876,"stddev":7471.219179365198,"max":139207.5450489507,"min":27216.67021050473,"percentiles":{"p10":121124.2248449689,"p25":126115.76447055531,"p50":128742.15708984584,"p75":130507.62164511153,"p90":132104.95393573944,"p95":132883.61036762426,"p99":134566.73164222387,"p99.9":136113.03962919628,"p99.99":139207.5450489507}},"details":{"DNSDialup":{"average":0.0004848416500000001,"fastest":0.000415959,"slowest":0.000564625},"DNSLookup":{"average":0.0000037688000000000002,"fastest":8.75e-7,"slowest":0.000032}},"statusCodeDistribution":{"200":3813800},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":424.08,"rpsPerCore":29976,"config":{"name":"No Spin + Tokio 2 Threads","description":"No semaphore spin with oha limited to 2 threads","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":4.4,"max":513.2,"average":424.08,"measured":true}},{"summary":{"successRate":1,"total":30.001249166,"slowest":0.0672515,"fastest":0.000036333,"average":0.0001751584078049803,"requestsPerSec":113995.18670295356,"totalData":13679980,"sizePerRequest":4,"sizePerSec":455980.34682846913},"responseTimeHistogram":{"0.000036333":1,"0.006757849700000001":3419934,"0.013479366400000001":20,"0.020200883100000004":20,"0.026922399800000003":0,"0.0336439165":0,"0.04036543320000001":0,"0.04708694990000001":0,"0.05380846660000001":0,"0.060529983300000006":0,"0.0672515":20},"latencyPercentiles":{"p10":0.000134583,"p25":0.000156042,"p50":0.000174958,"p75":0.000193541,"p90":0.000212792,"p95":0.00022625,"p99":0.000256708,"p99.9":0.000323333,"p99.99":0.000508125},"rps":{"mean":114237.1701051463,"stddev":5456.587599919216,"max":131841.75428359647,"min":14.911361350926159,"percentiles":{"p10":110535.45977549686,"p25":112441.69337990195,"p50":114310.48227122087,"p75":116415.36843161557,"p90":118621.24506500257,"p95":120135.53609159509,"p99":123329.7964788217,"p99.9":130440.76273832511,"p99.99":131841.75428359647}},"details":{"DNSDialup":{"average":0.00048514174999999995,"fastest":0.000353333,"slowest":0.000567584},"DNSLookup":{"average":0.00000208125,"fastest":7.91e-7,"slowest":0.000022375}},"statusCodeDistribution":{"200":3419995},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":399.89,"rpsPerCore":28507,"config":{"name":"No Spin + Tokio 1 Thread","description":"No semaphore spin with oha limited to 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":10.5,"max":507.3,"average":399.89,"measured":true}},{"summary":{"successRate":1,"total":30.000744125,"slowest":0.033521334,"fastest":0.000032083,"average":0.00014493985397951375,"requestsPerSec":135878.06299121256,"totalData":16305768,"sizePerRequest":4,"sizePerSec":543512.1186348241},"responseTimeHistogram":{"0.000032083":1,"0.0033810080999999996":4076217,"0.006729933199999999":134,"0.010078858299999998":27,"0.013427783399999999":24,"0.016776708499999998":24,"0.020125633599999995":10,"0.023474558699999995":1,"0.026823483799999995":3,"0.030172408899999996":0,"0.033521334":1},"latencyPercentiles":{"p10":0.000101375,"p25":0.000119667,"p50":0.000140959,"p75":0.000164333,"p90":0.00018825,"p95":0.000204292,"p99":0.000244917,"p99.9":0.000486917,"p99.99":0.00250525},"rps":{"mean":135803.1793970379,"stddev":12752.724536739106,"max":149365.51255642783,"min":82.66170696425272,"percentiles":{"p10":129863.42012788932,"p25":135011.81353368124,"p50":138018.97760940084,"p75":140426.96001450517,"p90":142410.68080106145,"p95":143605.98836972888,"p99":145888.74412306194,"p99.9":147919.5716007646,"p99.99":149365.51255642783}},"details":{"DNSDialup":{"average":0.0017901707999999998,"fastest":0.001354416,"slowest":0.002201291},"DNSLookup":{"average":0.00022967494999999997,"fastest":0.000001708,"slowest":0.000486375}},"statusCodeDistribution":{"200":4076442},"errorDistribution":{"aborted due to deadline":1},"cpuUsage":617.65,"rpsPerCore":21999,"config":{"name":"Base Case","description":"Default configuration","env":{},"ohaEnv":{}},"cpuMeasurement":{"samples":32,"min":0,"max":670.5,"average":617.65,"measured":true}},{"summary":{"successRate":1,"total":30.000550625,"slowest":0.006611583,"fastest":0.000032625,"average":0.0001737267246088574,"requestsPerSec":114935.32379124459,"totalData":13792484,"sizePerRequest":4,"sizePerSec":459741.02850320603},"responseTimeHistogram":{"0.000032625":1,"0.0006905208":3447424,"0.0013484166":451,"0.0020063124000000002":136,"0.0026642082":46,"0.0033221039999999998":37,"0.0039799998":19,"0.0046378956":3,"0.0052957913999999995":0,"0.005953687199999999":2,"0.006611582999999999":2},"latencyPercentiles":{"p10":0.000128583,"p25":0.000149166,"p50":0.000168375,"p75":0.000185583,"p90":0.000205208,"p95":0.000224625,"p99":0.000441417,"p99.9":0.000568959,"p99.99":0.001144541},"rps":{"mean":114923.10456111017,"stddev":14521.086592552361,"max":136292.3561365378,"min":34843.29304262957,"percentiles":{"p10":96698.71004322235,"p25":114065.68178601407,"p50":117796.34399146025,"p75":122816.37142233698,"p90":127756.43001515717,"p95":129847.60213093838,"p99":132623.76617891312,"p99.9":135148.99150942138,"p99.99":136292.3561365378}},"details":{"DNSDialup":{"average":0.0004212333499999999,"fastest":0.000346667,"slowest":0.000478209},"DNSLookup":{"average":0.0000020500499999999995,"fastest":8.33e-7,"slowest":0.000021375}},"statusCodeDistribution":{"200":3448121},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":863.8733333333332,"rpsPerCore":13305,"config":{"name":"Tokio 1 Thread","description":"Default config with oha limited to 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":13,"max":898.5,"average":863.8733333333332,"measured":true}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 2 Threads","No Spin + Tokio 1 Thread","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'Requests per Second',
          data: [109670.3027136224,125763.06484873225,127123.12356630374,113995.18670295356,135878.06299121256,114935.32379124459],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 2 Threads","No Spin + Tokio 1 Thread","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [133.9066666666667,389.6299999999999,424.08,399.89,617.65,863.8733333333332],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 2 Threads","No Spin + Tokio 1 Thread","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [81901,32278,29976,28507,21999,13305],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  