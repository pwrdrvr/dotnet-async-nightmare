
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 5.9x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>5.9x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">1 .NET Threads, oha 2</div>
      <div>1 .NET worker threads, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">130,327.734 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">81,841 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%) <sup>*</sup></th>
        <th>Min-Max CPU (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>1 .NET Threads, oha 2</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>110,103</td>
          <td>134.5% </td>
          <td>123.6-153.1</td>
          <td>81,841 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>1 .NET Thread</td>
          <td>1 .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>106,284</td>
          <td>131.7% </td>
          <td>123.9-147.5</td>
          <td>80,705 </td>
        </tr>
      
        <tr>
          <td>2 .NET Threads - oha 2</td>
          <td>2 .NET worker threads, no semaphore spin, oha with 2 threads</td>
          <td>130,328</td>
          <td>241.4% </td>
          <td>218.1-247.5</td>
          <td>53,985 </td>
        </tr>
      
        <tr>
          <td>No Spin</td>
          <td>Default .NET worker threads, no semaphore spin, oha with 1 thread</td>
          <td>112,111</td>
          <td>389.0% </td>
          <td>337.4-469.7</td>
          <td>28,824 </td>
        </tr>
      
        <tr>
          <td>Spin 10</td>
          <td>Default .NET worker threads, semaphore spin 10, oha with 1 thread</td>
          <td>120,027</td>
          <td>618.5% </td>
          <td>568.4-732.5</td>
          <td>19,406 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default .NET worker threads, default semaphore spin, oha with 1 thread</td>
          <td>114,494</td>
          <td>828.3% </td>
          <td>748.6-889.4</td>
          <td>13,823 </td>
        </tr>
      
      
      <tr>
        <td colspan="6" style="text-align: left; font-size: 0.9em; padding-top: 10px;">
          * CPU Usage shows the average usage across all samples. <sup>(est)</sup> indicates estimated values where measurement wasn't possible.
        </td>
      </tr>
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.0012375,"slowest":0.0064955,"fastest":0.000028667,"average":0.00018103844413680157,"requestsPerSec":110102.79159318013,"totalData":13212848,"sizePerRequest":4,"sizePerSec":440410.099750052},"responseTimeHistogram":{"0.000028667":1,"0.0006753503000000001":3301465,"0.0013220336000000002":1342,"0.0019687169000000004":220,"0.0026154002000000004":71,"0.0032620835000000004":28,"0.0039087668":31,"0.0045554501":31,"0.0052021334":15,"0.0058488167":6,"0.0064955":2},"latencyPercentiles":{"p10":0.00013875,"p25":0.0001585,"p50":0.000179042,"p75":0.000198416,"p90":0.000220708,"p95":0.000242625,"p99":0.000290166,"p99.9":0.000483583,"p99.99":0.001435791},"rps":{"mean":110099.02989853462,"stddev":11270.037998143245,"max":130330.33033035135,"min":13310.20360208181,"percentiles":{"p10":106616.8774516789,"p25":109154.86693506883,"p50":111406.96293518803,"p75":115104.05023131665,"p90":119003.47490146122,"p95":121313.22162974357,"p99":125938.00286353852,"p99.9":127989.02044935104,"p99.99":130330.33033035135}},"details":{"DNSDialup":{"average":0.0005062835000000001,"fastest":0.000426542,"slowest":0.000559958},"DNSLookup":{"average":0.00001363565,"fastest":0.000001334,"slowest":0.000131042}},"statusCodeDistribution":{"200":3303212},"errorDistribution":{"aborted due to deadline":8},"cpuUsage":134.53333333333336,"rpsPerCore":81841,"config":{"name":"1 .NET Threads, oha 2","description":"1 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":123.6,"max":153.1,"average":134.53333333333336,"measured":true}},{"summary":{"successRate":1,"total":30.001099167,"slowest":0.007370125,"fastest":0.000033917,"average":0.00018788636790125195,"requestsPerSec":106283.53922136816,"totalData":12754444,"sizePerRequest":4,"sizePerSec":425132.55694409274},"responseTimeHistogram":{"0.000033917":1,"0.0007675377999999999":3186364,"0.0015011586":1782,"0.0022347794":218,"0.0029684002":121,"0.0037020210000000002":14,"0.004435641799999999":65,"0.005169262599999999":17,"0.0059028833999999995":25,"0.0066365042":0,"0.007370125":4},"latencyPercentiles":{"p10":0.000131292,"p25":0.000160292,"p50":0.000188625,"p75":0.000212041,"p90":0.000235834,"p95":0.000253958,"p99":0.000298792,"p99.9":0.000638458,"p99.99":0.001969125},"rps":{"mean":106273.53915545101,"stddev":11667.78741115111,"max":132501.65627070202,"min":10003.668345182043,"percentiles":{"p10":99330.62363126062,"p25":102473.01202106489,"p50":106939.08244260972,"p75":112832.57827947677,"p90":117617.5422750485,"p95":120433.33959545726,"p99":124622.98539124512,"p99.9":129383.02536799315,"p99.99":132501.65627070202}},"details":{"DNSDialup":{"average":0.0005696207500000001,"fastest":0.000435625,"slowest":0.000629958},"DNSLookup":{"average":0.0000020479,"fastest":8.75e-7,"slowest":0.000021583}},"statusCodeDistribution":{"200":3188611},"errorDistribution":{"aborted due to deadline":12},"cpuUsage":131.69333333333333,"rpsPerCore":80705,"config":{"name":"1 .NET Thread","description":"1 .NET worker threads, no semaphore spin, oha with 1 thread","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":123.9,"max":147.5,"average":131.69333333333333,"measured":true}},{"summary":{"successRate":1,"total":30.001120041,"slowest":0.009942834,"fastest":0.000028083,"average":0.0001526791237000406,"requestsPerSec":130327.73425313998,"totalData":15639900,"sizePerRequest":4,"sizePerSec":521310.53702749324},"responseTimeHistogram":{"0.000028083":1,"0.0010195580999999999":3909114,"0.0020110332":477,"0.0030025082999999998":146,"0.0039939834":38,"0.0049854585":38,"0.0059769336":45,"0.0069684086999999995":17,"0.0079598838":22,"0.0089513589":11,"0.009942834":66},"latencyPercentiles":{"p10":0.000114,"p25":0.00013075,"p50":0.000149709,"p75":0.000170375,"p90":0.0001905,"p95":0.000204292,"p99":0.000243709,"p99.9":0.000484834,"p99.99":0.001993708},"rps":{"mean":130304.40874686521,"stddev":12080.875610196063,"max":156828.06579851662,"min":2401.5809607472056,"percentiles":{"p10":126016.79803918052,"p25":130660.97947908814,"p50":132677.5215719051,"p75":134426.88537708204,"p90":136301.70377129575,"p95":137433.63718321043,"p99":140596.7705694251,"p99.9":145315.6421880479,"p99.99":156828.06579851662}},"details":{"DNSDialup":{"average":0.0005022042000000002,"fastest":0.000453791,"slowest":0.000548416},"DNSLookup":{"average":0.00000378955,"fastest":9.58e-7,"slowest":0.00003075}},"statusCodeDistribution":{"200":3909975},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":241.41333333333336,"rpsPerCore":53985,"config":{"name":"2 .NET Threads - oha 2","description":"2 .NET worker threads, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"2","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}},"cpuMeasurement":{"samples":32,"min":218.1,"max":247.5,"average":241.41333333333336,"measured":true}},{"summary":{"successRate":1,"total":30.001119708,"slowest":0.051762542,"fastest":0.000038958,"average":0.0001780943819810739,"requestsPerSec":112111.48226254729,"totalData":13453860,"sizePerRequest":4,"sizePerSec":448445.26240840397},"responseTimeHistogram":{"0.000038958":1,"0.005211316400000001":3363424,"0.010383674800000001":0,"0.015556033200000001":20,"0.0207283916":0,"0.02590075":0,"0.0310731084":0,"0.0362454668":0,"0.0414178252":0,"0.0465901836":0,"0.051762542":20},"latencyPercentiles":{"p10":0.000136,"p25":0.00015775,"p50":0.000176542,"p75":0.000195417,"p90":0.000216083,"p95":0.000231375,"p99":0.000276625,"p99.9":0.000561583,"p99.99":0.001610375},"rps":{"mean":112262.11399099875,"stddev":8593.291221559846,"max":125278.29893682965,"min":19.4166745546911,"percentiles":{"p10":108709.05546431863,"p25":111325.50467311729,"p50":113419.93495251429,"p75":115427.8989231636,"p90":117301.46626832715,"p95":118736.11952757742,"p99":120964.8145598325,"p99.9":124245.98903711684,"p99.99":125278.29893682965}},"details":{"DNSDialup":{"average":0.00046615005000000004,"fastest":0.000358875,"slowest":0.0005255},"DNSLookup":{"average":0.00000222915,"fastest":7.92e-7,"slowest":0.000024333}},"statusCodeDistribution":{"200":3363465},"errorDistribution":{"aborted due to deadline":5},"cpuUsage":388.95666666666665,"rpsPerCore":28824,"config":{"name":"No Spin","description":"Default .NET worker threads, no semaphore spin, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":337.4,"max":469.7,"average":388.95666666666665,"measured":true}},{"summary":{"successRate":1,"total":30.001247666,"slowest":0.024220083,"fastest":0.000030917,"average":0.00016634058953506615,"requestsPerSec":120026.84155302357,"totalData":14403812,"sizePerRequest":4,"sizePerSec":480107.0995565175},"responseTimeHistogram":{"0.000030917":1,"0.0024498336000000004":3600833,"0.004868750200000001":59,"0.007287666800000001":20,"0.009706583400000001":0,"0.012125500000000003":20,"0.014544416600000002":0,"0.0169633332":0,"0.0193822498":0,"0.021801166400000002":0,"0.024220083000000003":20},"latencyPercentiles":{"p10":0.000126208,"p25":0.000145625,"p50":0.000164875,"p75":0.000184375,"p90":0.00020575,"p95":0.000220958,"p99":0.000260667,"p99.9":0.000450125,"p99.99":0.00133625},"rps":{"mean":120087.46525627718,"stddev":8589.224299848562,"max":135337.77277240774,"min":41.64316950827076,"percentiles":{"p10":113296.0603678338,"p25":117232.23886569247,"p50":120872.52351412119,"p75":124553.77832333736,"p90":127520.72211733977,"p95":129329.02877706088,"p99":132543.3428295768,"p99.9":135045.74136407525,"p99.99":135337.77277240774}},"details":{"DNSDialup":{"average":0.0004658354,"fastest":0.000361833,"slowest":0.000520584},"DNSLookup":{"average":0.0000020834,"fastest":7.92e-7,"slowest":0.000023}},"statusCodeDistribution":{"200":3600953},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":618.4933333333333,"rpsPerCore":19406,"config":{"name":"Spin 10","description":"Default .NET worker threads, semaphore spin 10, oha with 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"10"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":568.4,"max":732.5,"average":618.4933333333333,"measured":true}},{"summary":{"successRate":1,"total":30.002779709,"slowest":0.042310458,"fastest":0.000025416,"average":0.00017437172773787776,"requestsPerSec":114493.69136185595,"totalData":13740508,"sizePerRequest":4,"sizePerSec":457974.4988054634},"responseTimeHistogram":{"0.000025416":1,"0.0042539202000000005":3435017,"0.0084824244":42,"0.012710928600000001":3,"0.0169394328":24,"0.021167937":0,"0.0253964412":20,"0.0296249454":0,"0.0338534496":0,"0.0380819538":0,"0.042310458":20},"latencyPercentiles":{"p10":0.00012775,"p25":0.000148292,"p50":0.000167916,"p75":0.000186667,"p90":0.000208541,"p95":0.00023,"p99":0.000443542,"p99.9":0.00059325,"p99.99":0.002015958},"rps":{"mean":114726.84537663321,"stddev":14861.18197074801,"max":304761.904747663,"min":23.740234543547743,"percentiles":{"p10":98679.08557513644,"p25":112395.22261994741,"p50":118222.6514600274,"p75":122728.64486570805,"p90":126417.09199184208,"p95":128147.14307254695,"p99":131372.7702355443,"p99.9":135002.8215589911,"p99.99":304761.904747663}},"details":{"DNSDialup":{"average":0.0017672896499999998,"fastest":0.001154375,"slowest":0.00203075},"DNSLookup":{"average":0.000006225099999999999,"fastest":7.5e-7,"slowest":0.000107042}},"statusCodeDistribution":{"200":3435127},"errorDistribution":{"aborted due to deadline":2},"cpuUsage":828.3033333333334,"rpsPerCore":13823,"config":{"name":"Base Case","description":"Default .NET worker threads, default semaphore spin, oha with 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}},"cpuMeasurement":{"samples":32,"min":748.6,"max":889.4,"average":828.3033333333334,"measured":true}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second',
          data: [110102.79159318013,106283.53922136816,130327.73425313998,112111.48226254729,120026.84155302357,114493.69136185595],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [134.53333333333336,131.69333333333333,241.41333333333336,388.95666666666665,618.4933333333333,828.3033333333334],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["1 .NET Threads, oha 2","1 .NET Thread","2 .NET Threads - oha 2","No Spin","Spin 10","Base Case"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [81841,80705,53985,28824,19406,13823],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  