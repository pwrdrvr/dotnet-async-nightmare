
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET Async Thread Pool Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
    }
    .highlight-box {
      background-color: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin: 30px 0;
      border-radius: 0 4px 4px 0;
    }
    .metric-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #0066cc;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    .config-table th, .config-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .config-table tr:hover {
      background-color: #f9f9f9;
    }
    .fire-emoji {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <h1>.NET Async Thread Pool Performance</h1>
  <p>This dashboard visualizes the performance impact of different thread pool configurations in .NET 8.0. 
     The tests measure how various settings affect request throughput and CPU efficiency.</p>
  
  <div class="highlight-box">
    <h3>Key Finding: 4.4x Improvement in Efficiency!</h3>
    <p>By limiting worker threads to 1 and disabling semaphore spinning, we achieved 
       <strong>4.4x more requests per CPU core</strong> compared to the default configuration.</p>
  </div>
  
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-label">Best Configuration</div>
      <div class="metric-value">Single Worker Thread</div>
      <div>1 worker thread, no semaphore spin, oha with 2 threads</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Maximum Throughput</div>
      <div class="metric-value">129,472.095 req/sec</div>
      <div>Highest raw request throughput</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Best Efficiency</div>
      <div class="metric-value">345,611 req/sec/core</div>
      <div>Highest throughput per CPU core used</div>
    </div>
  </div>
  
  <div class="chart-container">
    <canvas id="rpsChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <canvas id="efficiencyChart"></canvas>
  </div>
  
  <h2>Configuration Details</h2>
  <table class="config-table">
    <thead>
      <tr>
        <th>Configuration</th>
        <th>Description</th>
        <th>Throughput (req/sec)</th>
        <th>CPU Usage (%)</th>
        <th>Efficiency (req/sec/core)</th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td>Single Worker Thread</td>
          <td>1 worker thread, no semaphore spin, oha with 2 threads</td>
          <td>104,893</td>
          <td>30.35%</td>
          <td>345,611 <span class="fire-emoji">ðŸ”¥</span></td>
        </tr>
      
        <tr>
          <td>No Semaphore Spin</td>
          <td>Disabling Semaphore spinning</td>
          <td>118,279</td>
          <td>105%</td>
          <td>112,646 </td>
        </tr>
      
        <tr>
          <td>No Spin + Tokio 1 Thread</td>
          <td>No semaphore spin with oha limited to 1 thread</td>
          <td>106,763</td>
          <td>100.3%</td>
          <td>106,443 </td>
        </tr>
      
        <tr>
          <td>No Spin + Tokio 2 Threads</td>
          <td>No semaphore spin with oha limited to 2 threads</td>
          <td>119,013</td>
          <td>112.35%</td>
          <td>105,931 </td>
        </tr>
      
        <tr>
          <td>Base Case</td>
          <td>Default configuration</td>
          <td>129,472</td>
          <td>166.14999999999998%</td>
          <td>77,925 </td>
        </tr>
      
        <tr>
          <td>Tokio 1 Thread</td>
          <td>Default config with oha limited to 1 thread</td>
          <td>103,083</td>
          <td>184.2%</td>
          <td>55,963 </td>
        </tr>
      
    </tbody>
  </table>
  
  <h2>Problem and Solution</h2>
  <p>The core issue is that .NET's ThreadPool and async/await mechanics cause excessive thread context switching 
     and CPU usage when handling HTTP requests. This is particularly problematic in high-throughput services.</p>
  
  <p>Key observations:</p>
  <ul>
    <li>Async task completions frequently move between threads, causing context switching overhead</li>
    <li>The ThreadPool's work-stealing algorithm can exacerbate this problem</li>
    <li>Semaphore spinning (waiting for work) consumes CPU without doing useful work</li>
    <li>Limiting worker threads forces task continuations to stay on the same thread</li>
  </ul>
  
  <script>
    // Load the benchmark data
    const data = [{"summary":{"successRate":1,"total":30.001233584,"slowest":0.009256834,"fastest":0.000028958,"average":0.00018991994080030602,"requestsPerSec":104892.82019650968,"totalData":12587632,"sizePerRequest":4,"sizePerSec":419570.480818933},"responseTimeHistogram":{"0.000028958":1,"0.0009517456":3145260,"0.0018745332":957,"0.0027973208":569,"0.0037201084":61,"0.004642896":40,"0.0055656836":0,"0.0064884712":4,"0.0074112588":7,"0.008334046400000001":8,"0.009256834":1},"latencyPercentiles":{"p10":0.000138916,"p25":0.000160917,"p50":0.000184333,"p75":0.000209209,"p90":0.000241125,"p95":0.00026725,"p99":0.000348208,"p99.9":0.000692666,"p99.99":0.002555},"rps":{"mean":104881.83054765634,"stddev":11094.45714325794,"max":126808.16828906345,"min":9481.74018579127,"percentiles":{"p10":95265.55272822148,"p25":104285.80499398289,"p50":107688.0017133968,"p75":110109.63459306359,"p90":112825.38571178359,"p95":114788.47895958507,"p99":118620.26034045932,"p99.9":124031.00775193945,"p99.99":126808.16828906345}},"details":{"DNSDialup":{"average":0.0006671083000000001,"fastest":0.000626792,"slowest":0.000699875},"DNSLookup":{"average":0.000005608300000000001,"fastest":0.000001125,"slowest":0.0000485}},"statusCodeDistribution":{"200":3146908},"errorDistribution":{"aborted due to deadline":6},"cpuUsage":30.35,"rpsPerCore":345611,"config":{"name":"Single Worker Thread","description":"1 worker thread, no semaphore spin, oha with 2 threads","env":{"LAMBDA_DISPATCH_MaxWorkerThreads":"1","DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}}},{"summary":{"successRate":1,"total":30.000274084,"slowest":0.003809834,"fastest":0.000029166,"average":0.00016705553925587232,"requestsPerSec":118278.61939076276,"totalData":14193544,"sizePerRequest":4,"sizePerSec":473113.8109024751},"responseTimeHistogram":{"0.000029166":1,"0.0004072328":3541581,"0.0007852995999999999":5603,"0.0011633663999999998":374,"0.0015414331999999999":184,"0.0019195":114,"0.0022975668":241,"0.0026756336":153,"0.0030537004":75,"0.0034317672":20,"0.0038098340000000002":40},"latencyPercentiles":{"p10":0.000109333,"p25":0.000134167,"p50":0.000163125,"p75":0.000193791,"p90":0.00022475,"p95":0.00024675,"p99":0.000306,"p99.9":0.000474583,"p99.99":0.002201625},"rps":{"mean":118273.26106484643,"stddev":10791.762754011712,"max":138516.74667465902,"min":34533.98169190712,"percentiles":{"p10":106219.91623430252,"p25":113828.45711427993,"p50":120303.00757516298,"p75":125301.03999863168,"p90":128754.17975884533,"p95":130762.35453938312,"p99":134222.37486990908,"p99.9":137547.2856334535,"p99.99":138516.74667465902}},"details":{"DNSDialup":{"average":0.00055794995,"fastest":0.000451791,"slowest":0.000778167},"DNSLookup":{"average":0.00007214589999999998,"fastest":0.000001834,"slowest":0.000239042}},"statusCodeDistribution":{"200":3548386},"errorDistribution":{"aborted due to deadline":5},"cpuUsage":105,"rpsPerCore":112646,"config":{"name":"No Semaphore Spin","description":"Disabling Semaphore spinning","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{}}},{"summary":{"successRate":1,"total":30.00126475,"slowest":0.053044833,"fastest":0.000032625,"average":0.00018701121329832857,"requestsPerSec":106762.79905832969,"totalData":12812064,"sizePerRequest":4,"sizePerSec":427050.7962501814},"responseTimeHistogram":{"0.000032625":1,"0.0053338458":3202931,"0.0106350666":44,"0.015936287400000002":0,"0.0212375082":0,"0.026538729":20,"0.0318399498":0,"0.0371411706":0,"0.0424423914":0,"0.0477436122":0,"0.053044833":20},"latencyPercentiles":{"p10":0.000140875,"p25":0.000162167,"p50":0.000181125,"p75":0.000202625,"p90":0.000231167,"p95":0.000257208,"p99":0.000346166,"p99.9":0.000633458,"p99.99":0.002468583},"rps":{"mean":106950.06047628712,"stddev":9679.627363627435,"max":120436.63682491813,"min":18.922475167988747,"percentiles":{"p10":98471.39175902207,"p25":105065.0361587754,"p50":109235.96047818859,"p75":112003.2592948589,"p90":113836.84890769495,"p95":114811.96340657993,"p99":116832.12883541337,"p99.9":118630.65416103478,"p99.99":120436.63682491813}},"details":{"DNSDialup":{"average":0.0007033439000000001,"fastest":0.000428583,"slowest":0.000862208},"DNSLookup":{"average":0.0000021251,"fastest":8.34e-7,"slowest":0.000022292}},"statusCodeDistribution":{"200":3203016},"errorDistribution":{"aborted due to deadline":3},"cpuUsage":100.3,"rpsPerCore":106443,"config":{"name":"No Spin + Tokio 1 Thread","description":"No semaphore spin with oha limited to 1 thread","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}}},{"summary":{"successRate":1,"total":30.000524541,"slowest":0.005362167,"fastest":0.000031291,"average":0.000167165531022403,"requestsPerSec":119013.11909131662,"totalData":14281808,"sizePerRequest":4,"sizePerSec":476051.94304125814},"responseTimeHistogram":{"0.000031291":1,"0.0005643786":3568302,"0.0010974662":1255,"0.0016305538":227,"0.0021636414":244,"0.002696729":328,"0.0032298166":27,"0.0037629042":9,"0.0042959918":39,"0.0048290794":0,"0.005362167":20},"latencyPercentiles":{"p10":0.000115292,"p25":0.000135791,"p50":0.000160459,"p75":0.000189625,"p90":0.000224083,"p95":0.000249875,"p99":0.000318791,"p99.9":0.000479458,"p99.99":0.002269708},"rps":{"mean":119005.71219160096,"stddev":10299.559960172455,"max":134756.15288893785,"min":22423.077831706414,"percentiles":{"p10":107237.53313660058,"p25":115529.25838639327,"p50":121437.4391624878,"p75":125585.76646575864,"p90":128360.43209143805,"p95":129828.13375658635,"p99":131939.04076213684,"p99.9":133516.14210156666,"p99.99":134756.15288893785}},"details":{"DNSDialup":{"average":0.0004992250000000001,"fastest":0.000406709,"slowest":0.000548958},"DNSLookup":{"average":0.000005845849999999999,"fastest":0.000001375,"slowest":0.000054583}},"statusCodeDistribution":{"200":3570452},"errorDistribution":{"aborted due to deadline":4},"cpuUsage":112.35,"rpsPerCore":105931,"config":{"name":"No Spin + Tokio 2 Threads","description":"No semaphore spin with oha limited to 2 threads","env":{"DOTNET_ThreadPool_UnfairSemaphoreSpinLimit":"0"},"ohaEnv":{"TOKIO_WORKER_THREADS":"2"}}},{"summary":{"successRate":1,"total":30.001847167,"slowest":0.018410583,"fastest":0.000027292,"average":0.00015214125778517478,"requestsPerSec":129472.09478063667,"totalData":15537604,"sizePerRequest":4,"sizePerSec":517888.2457974225},"responseTimeHistogram":{"0.000027292":1,"0.0018656210999999999":3883628,"0.0037039501999999998":642,"0.0055422792999999995":92,"0.0073806084":17,"0.0092189375":5,"0.011057266599999999":5,"0.0128955957":3,"0.0147339248":3,"0.0165722539":1,"0.018410583":4},"latencyPercentiles":{"p10":0.000102334,"p25":0.000121958,"p50":0.000145792,"p75":0.000173208,"p90":0.000203,"p95":0.000225125,"p99":0.000295458,"p99.9":0.000625959,"p99.99":0.00246425},"rps":{"mean":129462.08911172608,"stddev":11227.125736023674,"max":147449.2924085697,"min":14986.862355523113,"percentiles":{"p10":118327.61766596338,"p25":126574.88170002901,"p50":131806.59032951435,"p75":135722.1499349373,"p90":138634.6586646678,"p95":140543.9199749592,"p99":143714.37143716155,"p99.9":145774.92991589426,"p99.99":147449.2924085697}},"details":{"DNSDialup":{"average":0.0027539270999999994,"fastest":0.001802834,"slowest":0.003326666},"DNSLookup":{"average":0.00044118555,"fastest":0.000001875,"slowest":0.000897084}},"statusCodeDistribution":{"200":3884401},"errorDistribution":{"aborted due to deadline":1},"cpuUsage":166.14999999999998,"rpsPerCore":77925,"config":{"name":"Base Case","description":"Default configuration","env":{},"ohaEnv":{}}},{"summary":{"successRate":1,"total":30.001171917,"slowest":0.050058625,"fastest":0.000039125,"average":0.00019368148866204105,"requestsPerSec":103083.43982548166,"totalData":12370480,"sizePerRequest":4,"sizePerSec":412333.2259894266},"responseTimeHistogram":{"0.000039125":1,"0.005041075":3092588,"0.010043024999999999":7,"0.015044974999999999":1,"0.020046925":3,"0.025048874999999998":0,"0.030050825":0,"0.035052775":0,"0.040054725":0,"0.045056675":0,"0.050058624999999995":20},"latencyPercentiles":{"p10":0.000136542,"p25":0.000158416,"p50":0.000176,"p75":0.000195958,"p90":0.00023725,"p95":0.000406959,"p99":0.00050325,"p99.9":0.000635958,"p99.99":0.002635334},"rps":{"mean":103205.22199920971,"stddev":17665.530124075125,"max":131951.68547520225,"min":20.129938754661968,"percentiles":{"p10":76312.08783471167,"p25":93769.53949049527,"p50":110168.46962375651,"p75":116101.93890237757,"p90":118625.20785667164,"p95":120705.7960637725,"p99":125013.0451664039,"p99.9":129219.38290743584,"p99.99":131951.68547520225}},"details":{"DNSDialup":{"average":0.0004333293,"fastest":0.000345416,"slowest":0.000548042},"DNSLookup":{"average":0.0000024875999999999997,"fastest":7.92e-7,"slowest":0.000028167}},"statusCodeDistribution":{"200":3092620},"errorDistribution":{"aborted due to deadline":4},"cpuUsage":184.2,"rpsPerCore":55963,"config":{"name":"Tokio 1 Thread","description":"Default config with oha limited to 1 thread","env":{},"ohaEnv":{"TOKIO_WORKER_THREADS":"1"}}}];
    
    // Chart colors
    const colors = [
      'rgba(0, 102, 204, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 99, 132, 0.8)'
    ];
    
    // Create RPS chart
    const rpsCtx = document.getElementById('rpsChart').getContext('2d');
    new Chart(rpsCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 1 Thread","No Spin + Tokio 2 Threads","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'Requests per Second',
          data: [104892.82019650968,118278.61939076276,106762.79905832969,119013.11909131662,129472.09478063667,103083.43982548166],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Raw Throughput (Requests per Second)',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec'
            }
          }
        }
      }
    });
    
    // Create CPU usage chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 1 Thread","No Spin + Tokio 2 Threads","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'CPU Usage (%)',
          data: [30.35,105,100.3,112.35,166.14999999999998,184.2],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'CPU Utilization',
            font: { size: 16 }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'CPU Usage (%)'
            }
          }
        }
      }
    });
    
    // Create efficiency chart
    const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(efficiencyCtx, {
      type: 'bar',
      data: {
        labels: ["Single Worker Thread","No Semaphore Spin","No Spin + Tokio 1 Thread","No Spin + Tokio 2 Threads","Base Case","Tokio 1 Thread"],
        datasets: [{
          label: 'Requests per Second per CPU Core',
          data: [345611,112646,106443,105931,77925,55963],
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Efficiency (Requests per Second per CPU Core)',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.raw.toLocaleString() + ' req/sec/core';
              }
            }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Requests/sec/core'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
  